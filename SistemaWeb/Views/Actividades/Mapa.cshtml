@model IEnumerable<SistemaWeb.Models.Actividad>

@{
    ViewData["Title"] = "Mapa de Actividades";
}
<style>


    body {
        background-color: var(--bg-body);
        background-image: url(/img/br.jpg); /* Asegúrate de que esta imagen exista */
        background-repeat: no-repeat;
        background-position: center center;
        background-size: cover;
        background-attachment: fixed;
        
    }

</style>
<div class="container mt-4">
    <h2>📍 Mapa de Actividades Inclusivas</h2>
    <p>Visualiza la ubicación de todas las actividades registradas en el sistema.</p>

    <div id="map" style="height: 600px; width: 100%; border-radius: 8px; border: 1px solid #ccc;"></div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin="" />

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        // 1. Inicializar Mapa (Centrado en Ecuador)
        var map = L.map('map').setView([-1.8312, -78.1834], 7); // Zoom más alejado para ver todo el país

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // 2. Obtener datos (Raw Data)
        var actividades = @Json.Serialize(Model);

        // --- DEBUG: MIRA ESTO EN LA CONSOLA DEL NAVEGADOR (F12) ---
        console.log("=== INICIO DE DEBUG MAPA ===");
        console.log("Total actividades recuperadas:", actividades.length);
        console.log("Datos crudos:", actividades);

        var puntosDibujados = 0;

        // 3. Iterar de forma segura
        actividades.forEach(function (item, index) {

            // TRUCO DE DEV: Intentamos leer la propiedad en Mayúscula O minúscula
            // Esto arregla el error de serialización.
            var lat = item.Latitud || item.latitud || 0;
            var lng = item.Longitud || item.longitud || 0;
            var nombre = item.Nombre || item.nombre || "Actividad sin nombre";
            var resp = item.Responsable || item.responsable || "Sin responsable";
            var tipo = item.TipoDiscapacidad || item.tipoDiscapacidad || "General";
            var codigo = item.Codigo || item.codigo || "";

            // Convertir a float por seguridad
            lat = parseFloat(lat);
            lng = parseFloat(lng);

            // Log por cada fila para ver si detecta coordenadas
            console.log(`Fila ${index}: ${nombre} -> Lat: ${lat}, Lng: ${lng}`);

            // Solo dibujamos si las coordenadas son válidas (diferentes de 0)
            if (lat !== 0 && lng !== 0) {

                var marker = L.marker([lat, lng]).addTo(map);

                var popupContent = `
                    <div style="text-align:center;">
                        <h6>${nombre}</h6>
                        <p><b>Responsable:</b> ${resp}</p>
                        <span class="badge bg-info text-dark">${tipo}</span>
                        <br/><br/>
                        <a href="/Actividades/Editar?id=${codigo}" class="btn btn-sm btn-primary">Ver Detalles</a>
                    </div>
                `;

                marker.bindPopup(popupContent);
                puntosDibujados++;
            }
        });

        console.log("Total puntos dibujados en el mapa:", puntosDibujados);

        if (puntosDibujados === 0) {
            alert("Atención: El sistema no encontró coordenadas válidas para dibujar. Revisa la Consola (F12) para más detalles.");
        }
    });
</script>