@model IEnumerable<SistemaWeb.Models.Actividad>
@{
    ViewData["Title"] = "Mapa de Eventos";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold" style="color: var(--uisek-blue);">
            <i class="fas fa-map-marked-alt me-2"></i>Geolocalización de Eventos
        </h2>
        <a asp-action="Index" class="btn btn-outline-secondary rounded-pill">
            <i class="fas fa-arrow-left me-2"></i>Volver al Listado
        </a>
    </div>

    <div class="card shadow-lg border-0 rounded-4 overflow-hidden animate__animated animate__fadeIn">
        <div class="card-body p-0">
            <div id="map" style="height: 600px; width: 100%;"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            
            // A. Coordenadas iniciales (UISEK / Quito)
            var latitudDefault = -0.0910;
            var longitudDefault = -78.4840;

            // B. Inicializar el mapa con Leaflet (L.map)
            // 'map' es el id del div
            var map = L.map('map').setView([latitudDefault, longitudDefault], 14);

            // C. Cargar las "baldosas" (el dibujo del mapa) desde OpenStreetMap (Gratis)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // D. Traer datos de C# a Javascript (Igual que antes)
            var eventos = @Json.Serialize(Model.Select(e => new { 
                titulo = e.Nombre, 
                lat = e.Latitud, 
                lng = e.Longitud,
                desc = e.Responsable 
            }));

            // E. Recorrer y crear marcadores
            eventos.forEach(function(evento) {
                // Verificamos que tenga coordenadas válidas
                if (evento.lat !== 0 && evento.lng !== 0) {
                    
                    // Crear marcador en Leaflet
                    var marker = L.marker([evento.lat, evento.lng]).addTo(map);

                    // Crear el contenido del Popup (Ventana de info)
                    var contenidoPopup = `
                        <div class="text-center">
                            <h6 class="fw-bold text-primary mb-1" style="color: var(--uisek-blue) !important;">
                                ${evento.titulo}
                            </h6>
                            <p class="mb-0 text-muted small">
                                <b>Responsable:</b> ${evento.desc}
                            </p>
                        </div>
                    `;

                    // Asignar el popup al marcador
                    marker.bindPopup(contenidoPopup);
                }
            });
        });
    </script>
}